BuildStamp = main.BuildStamp=$(shell date '+%Y-%m-%d_%I:%M:%S%p')
GitHash    = main.GitHash=$(shell git rev-parse HEAD)
Target     = $(shell basename $(abspath $(dir $$PWD)))

all: clean wget convert compile
	./release/${Target}

wget:
	wget https://raw.githubusercontent.com/offensive-security/exploit-database/master/files_exploits.csv
	wget https://raw.githubusercontent.com/offensive-security/exploit-database/master/files_shellcodes.csv

convert:
	sqlite3 exploit.db < files_exploits.sql
	sqlite3 exploit.db < files_shellcodes.sql

compile:
	go build -v -o ./release/${Target} -ldflags "-s -w -X ${BuildStamp} -X ${GitHash}"

clean:
	-rm -rf *.csv *.db *.json release

worktree:
	git remote add gh-pages git@github.com:tosone/ExploitDatabase.git
	git fetch gh-pages && git fetch gh-pages gh-pages:gh-pages
	git worktree add -B gh-pages public gh-pages

release:
	cd public && git add . && git commit -am "Rebuilding site `date`" && git push gh-pages gh-pages

.PHONY: release
